C51 COMPILER V9.60.7.0   IIC                                                               03/26/2025 22:07:10 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE IIC
OBJECT MODULE PLACED IN .\Objects\iic.obj
COMPILER INVOKED BY: D:\Keli5\C51\BIN\C51.EXE ..\Driver\Src\iic.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\User\Inc;..\Driver\
                    -Inc) DEBUG OBJECTEXTEND PRINT(.\Listings\iic.lst) OBJECT(.\Objects\iic.obj)

line level    source

   1          #include "iic.h"
   2          
   3          #define DELAY_TIME      10
   4          
   5          //
   6          static void I2C_Delay(unsigned char n)
   7          {
   8   1          do
   9   1          {
  10   2              _nop_();_nop_();_nop_();_nop_();_nop_();
  11   2              _nop_();_nop_();_nop_();_nop_();_nop_();
  12   2              _nop_();_nop_();_nop_();_nop_();_nop_();                
  13   2          }
  14   1          while(n--);         
  15   1      }
  16          
  17          //
  18          void I2CStart(void)
  19          {
  20   1          sda = 1;
  21   1          scl = 1;
  22   1              I2C_Delay(DELAY_TIME);
  23   1          sda = 0;
  24   1              I2C_Delay(DELAY_TIME);
  25   1          scl = 0;    
  26   1      }
  27          
  28          //
  29          void I2CStop(void)
  30          {
  31   1          sda = 0;
  32   1          scl = 1;
  33   1              I2C_Delay(DELAY_TIME);
  34   1          sda = 1;
  35   1              I2C_Delay(DELAY_TIME);
  36   1      }
  37          
  38          //
  39          void I2CSendByte(unsigned char byt)
  40          {
  41   1          unsigned char i;
  42   1              
  43   1          for(i=0; i<8; i++){
  44   2              scl = 0;
  45   2                      I2C_Delay(DELAY_TIME);
  46   2              if(byt & 0x80){
  47   3                  sda = 1;
  48   3              }
  49   2              else{
  50   3                  sda = 0;
  51   3              }
  52   2                      I2C_Delay(DELAY_TIME);
  53   2              scl = 1;
  54   2              byt <<= 1;
C51 COMPILER V9.60.7.0   IIC                                                               03/26/2025 22:07:10 PAGE 2   

  55   2                      I2C_Delay(DELAY_TIME);
  56   2          }
  57   1              
  58   1          scl = 0;  
  59   1      }
  60          
  61          //
  62          unsigned char I2CReceiveByte(void)
  63          {
  64   1              unsigned char da;
  65   1              unsigned char i;
  66   1              for(i=0;i<8;i++){   
  67   2                      scl = 1;
  68   2                      I2C_Delay(DELAY_TIME);
  69   2                      da <<= 1;
  70   2                      if(sda) 
  71   2                              da |= 0x01;
  72   2                      scl = 0;
  73   2                      I2C_Delay(DELAY_TIME);
  74   2              }
  75   1              return da;    
  76   1      }
  77          
  78          //
  79          unsigned char I2CWaitAck(void)
  80          {
  81   1              unsigned char ackbit;
  82   1              
  83   1          scl = 1;
  84   1              I2C_Delay(DELAY_TIME);
  85   1          ackbit = sda; 
  86   1          scl = 0;
  87   1              I2C_Delay(DELAY_TIME);
  88   1              
  89   1              return ackbit;
  90   1      }
  91          
  92          //
  93          void I2CSendAck(unsigned char ackbit)
  94          {
  95   1          scl = 0;
  96   1          sda = ackbit; 
  97   1              I2C_Delay(DELAY_TIME);
  98   1          scl = 1;
  99   1              I2C_Delay(DELAY_TIME);
 100   1          scl = 0; 
 101   1              sda = 1;
 102   1              I2C_Delay(DELAY_TIME);
 103   1      }
 104          
 105          /**
 106           * @brief ä»ŽPCF8951è¯»å–ADè½¬æ¢çš„ç»“æžœ
 107           * 
 108           * @param addr è¦è¯»å–çš„åœ°å€çš„ä½ç½®
 109           * @return uint8_t è¿”å›žè¯»å–åˆ°çš„è½¬æ¢å€¼
 110           * @note å¦‚æžœé¢˜ç›®è¦æ±‚è¯»å–ä¸¤ä¸ªADè½¬æ¢çš„çš„å€¼ï¼Œéœ€è¦å°†ä¸¤ä¸ªå€¼çš„å€¼çš„ä½ç½®äº¤æ¢
 111           *       å› ä¸ºæœ¬æ¬¡è¯»åˆ°çš„å€¼æ˜¯ä¸Šä¸€æ¬¡è½¬æ¢å®Œæˆçš„å€¼ã€‚
 112           */
 113          uint8_t AD_Read(uint8_t addr)
 114          {
 115   1          uint8_t temp = 0x00;
 116   1      
C51 COMPILER V9.60.7.0   IIC                                                               03/26/2025 22:07:10 PAGE 3   

 117   1          //ç¬¬ä¸€é˜¶æ®µ å†™é˜¶æ®µï¼ˆå…¶å®žæ˜¯å‘Šè¯‰ä»Žæœºæˆ‘è¦ä»Žå“ªä¸ªåœ°å€çš„å¯„å­˜å™¨è¯»å–æ•°æ®ï¼‰
 118   1          I2CStart();//å¼€å¯é€šè®¯
 119   1          I2CSendByte(ADDR_PCF8951 | 0x00);//å¯¹PCF8951å†™æ•°æ®
 120   1          I2CWaitAck();//ç­‰å¾…ä»Žæœºå›žåº”
 121   1          I2CSendByte(addr);//å‘Šè¯‰ä»Žæœºè¦è¯»å–æ•°æ®çš„åœ°å€
 122   1          I2CWaitAck();//ç­‰å¾…ä»Žæœºå›žåº”
 123   1      
 124   1          //ç¬¬äºŒé˜¶æ®µ è¯»æ•°æ®é˜¶æ®µ
 125   1          I2CStart();//å¼€å¯é€šè®¯
 126   1          I2CSendByte(ADDR_PCF8951 | 0x01);//è¯»PCF8951è¯»æ•°æ®
 127   1          I2CWaitAck();//ç­‰å¾…ä»Žæœºå›žåº”
 128   1          temp = I2CReceiveByte();//ä»Žç¬¬ä¸€é˜¶æ®µè¾“å…¥çš„åœ°å€è¯»å–æ•°æ®ï¼Œå­˜å…¥temp
 129   1          I2CSendAck(1);//å‘ä»Žæœºå‘é€1ï¼Œå‘Šè¯‰ä»Žæœºä¸å†å‘é€æ•°æ®
 130   1          I2CStop();//é€šè®¯ç»“æŸ
 131   1          
 132   1          return temp;
 133   1      }
 134          
 135          /**
 136           * @brief æ•°æ¨¡è½¬æ¢ä»Žå¯¹åº”å¼•è„šè¾“å‡ºæ¨¡æ‹Ÿé‡
 137           * 
 138           * @param dat è¾“å…¥å¯¹åº”çš„æ•°å­—é‡
 139           */
 140          void DA_Write(uint8_t dat)
 141          {
 142   1              I2CStart();//å¼€å¯
 143   1              I2CSendByte(ADDR_PCF8951 | 0x00);//é€‰ä¸­åœ°å€ 0x90 å†™æ¨¡å¼
 144   1              I2CWaitAck();//ç­‰å¾…åº”ç­”
 145   1              I2CSendByte(0x43);//å‘é€0x4xï¼šè®©æ¨¡æ‹Ÿä¿¡å·è¾“å‡ºä½¿èƒ½
 146   1              I2CWaitAck();//ç­‰å¾…åº”ç­”
 147   1              I2CSendByte(dat);//å†™å…¥è½¬æ¢é‡
 148   1              I2CWaitAck();//ç­‰å¾…åº”ç­”
 149   1              I2CStop();//ç»“æŸ
 150   1      }
 151          
 152          /**
 153           * @brief å‘AT24C02ä¸­è¢«æŒ‡å®šçš„åœ°å€å†™å…¥å¯¹åº”çš„æ•°æ®
 154           * 
 155           * @param e2prom_string å¾…å†™å…¥çš„æ•°æ®
 156           * @param addr è¦å†™å…¥æ•°æ®çš„åœ°å€ï¼ˆæœ€å¥½ä¸º8çš„å€æ•°ï¼‰
 157           * @param num é¡µæ•°ï¼ˆå•é¡µæœ€å¤§å€¼ä¸º8å­—èŠ‚ï¼‰
 158           */
 159          void E2prom_Write(uint8_t *e2prom_string,uint8_t addr,uint8_t num)
 160          {
 161   1              I2CStart();//å¼€å¯i2cé€šè®¯
 162   1              I2CSendByte(ADDR_AT24C02 | 0x00);//é€‰ä¸­at24c02èŠ¯ç‰‡ å†™æ¨¡å¼ 0-å†™æ¨¡å¼ 1-è¯»æ¨¡å¼
 163   1              I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 164   1              
 165   1              I2CSendByte(addr);//å‘at24c02å†™å…¥æ•°æ®  å‘ŠçŸ¥å†™å…¥æ•°æ®å­˜æ”¾åœ¨at24c02èŠ¯ç‰‡çš„åœ°å€
 166   1              I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 167   1              
 168   1              while(num--)//å½“å‰å†™å…¥é¡µæ•°
 169   1              {
 170   2                      I2CSendByte(*e2prom_string++ );//å‘at24c02èŠ¯ç‰‡addråœ°å€ä¸­å†™å…¥ç¬¬ä¸€æ‰¹æ•°æ®
 171   2                      I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 172   2                      I2C_Delay(200);//å»¶æ—¶
 173   2              }
 174   1              
 175   1              I2CStop();//ç»“æŸé€šè®¯
 176   1      }
 177          
 178          /**
C51 COMPILER V9.60.7.0   IIC                                                               03/26/2025 22:07:10 PAGE 4   

 179           * @brief ä»ŽAT24C02çš„æŒ‡å®šåœ°å€è¯»å–æ•°æ®å­˜å‚¨åˆ°æ•°ç»„ä¸­
 180           * 
 181           * @param e2prom_string æ•°æ®å­˜å‚¨çš„æ•°ç»„
 182           * @param addr åœ°å€ï¼ˆæœ€å¥½ä¸º8çš„å€æ•°ï¼‰
 183           * @param num é¡µæ•°ï¼ˆå•é¡µæœ€å¤§å€¼ä¸º8å­—èŠ‚ï¼‰
 184           */
 185          void E2prom_Read(uint8_t *e2prom_string,uint8_t addr,uint8_t num)
 186          {
 187   1              I2CStart();//å¼€å¯i2cé€šè®¯
 188   1              I2CSendByte(ADDR_AT24C02 | 0x00);//é€‰ä¸­at24c02èŠ¯ç‰‡ å†™æ¨¡å¼ aï¼š1010ä¸ºat24c02åœ°å€ 0-å†™æ¨¡å¼ 1-è
             -¯»æ¨¡å¼
 189   1              I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 190   1              
 191   1              I2CSendByte(addr);//å‘at24c02å†™å…¥æ•°æ®  å‘ŠçŸ¥å†™å…¥æ•°æ®å­˜æ”¾åœ¨at24c02èŠ¯ç‰‡çš„åœ°å€
 192   1              I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 193   1              
 194   1              I2CStart();//å¼€å¯i2cé€šè®¯
 195   1              I2CSendByte(ADDR_AT24C02 | 0x01);//é€‰ä¸­at24c02èŠ¯ç‰‡ å†™æ¨¡å¼ aï¼š1010ä¸ºat24c02åœ°å€ 0-å†™æ¨¡å¼ 1-è
             -¯»æ¨¡å¼
 196   1              I2CWaitAck();//ç­‰å¾…ä»Žæœºåº”ç­”
 197   1              
 198   1              while(num--)//å½“å‰è¯»å–é¡µæ•°
 199   1              {
 200   2                      *e2prom_string++ = I2CReceiveByte();//å°†è¯»å–åˆ°çš„æ•°æ®å­˜å…¥æ•°ç»„e2prom_string
 201   2                      if(num)I2CSendAck(0);//numä¸ç­‰äºŽ0çš„è¯å°±å‘é€åº”ç­”
 202   2                      else I2CSendAck(1);//numä¸º0ä»£è¡¨å½“å‰å¾ªçŽ¯ä¸ºæœ€åŽä¸€ä¸ªå¾ªçŽ¯ ä¸éœ€è¦å†æ¬¡å‘é€åº”ç­”
 203   2              }
 204   1              
 205   1              I2CStop();//ç»“æŸé€šè®¯
 206   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    362    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----      10
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
