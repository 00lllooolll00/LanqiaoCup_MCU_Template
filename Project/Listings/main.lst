C51 COMPILER V9.60.7.0   MAIN                                                              03/27/2025 20:34:03 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: D:\Keli5\C51\BIN\C51.EXE ..\User\Src\main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\User\Inc;..\Driver\I
                    -nc) DEBUG OBJECTEXTEND PRINT(.\Listings\main.lst) OBJECT(.\Objects\main.obj)

line level    source

   1          /**
   2           * @file main.c
   3           * @author ä¹åƒä¹ç™¾ä¹åä¹
   4           * @brief  åŸºäºè¥¿é£å›¢é˜Ÿçš„æ¨¡æ¿ï¼ŒåŠ ä¸Šè‡ªå·±å†™çš„è°ƒåº¦å™¨ï¼Œå›Šæ‹¬äº†è“æ¡¥æ¯å•ç‰‡æœºçš„æ‰€æœ
             -‰å¤–è®¾ï¼Œå¹¶ä¸”ä¸ºæ¯ä¸€ç§å¤–è®¾éƒ½æä¾›äº†å¯¹åº”çš„ä¾‹å­å’Œæ³¨é‡Šã€‚
   5           * @version 0.1
   6           * @date 2025-03-26
   7           * 
   8           * @copyright Copyright (c) 2025
   9           * 
  10           */
  11          /*HEADER*/
  12          #include "main.h"
  13          #include "Task.h"
  14          #include "SysInit.h"
  15          #include "TIM.h"
  16          #include "LED.h"
  17          #include "Seg.h"
  18          #include "Key.h"
  19          #include "Delay.h"
  20          #include "Periph.h"
  21          #include "iic.h"
  22          #include "onewire.h"
  23          #include "ds1302.h"
  24          #include "Ultrasonic.h"
  25          #include "Serial.h"
  26          
  27          /*Global Variable*/
  28          uint32_t xdata Mysystick = 0;//ç³»ç»Ÿå¿ƒè·³
  29          uint8_t pdata Seg_Buf[8];//æ•°ç ç®¡æ˜¾ç¤ºç¼“å­˜
  30          uint8_t pdata Seg_Point[8];//æ•°ç ç®¡å°æ•°ç‚¹æ˜¾ç¤ºç¼“å­˜
  31          uint8_t pdata ucLed[8];//LEDç¯æ˜¾ç¤ºç¼“å­˜
  32          uint8_t pdata ucRTC[3]={23,59,50};//æ—¶é—´å‚¨å­˜ æ—¶ã€åˆ†ã€ç§’
  33          float temprature;//æ¸©åº¦
  34          uint8_t RxData[5];//ä¸²å£æ¥æ”¶åˆ°çš„çš„æ•°æ®
  35          uint8_t Serial_Idle_Cnt;//ä¸²å£ç©ºé—²è®¡æ—¶å™¨
  36          uint8_t index;//æŒ‡ç¤ºå½“å‰æ¥æ”¶åˆ°æ•°æ®çš„ç´¢å¼•
  37          uint8_t Adval1;//ADè½¬æ¢å€¼
  38          uint8_t Adval2;//ADè½¬æ¢å€¼
  39          
  40          /*Task1 Creation Key*/
  41          void Task_Key(void)
  42          {
  43   1          static uint8_t Key_Val;
  44   1          static uint8_t Key_Down;
  45   1          static uint8_t Key_Up;
  46   1          static uint8_t Key_Old = 0;//è¯¥å€¼åˆå§‹ç»™0 é¿å…è­¦å‘Š
  47   1      
  48   1          Key_Val = Key_Read();
  49   1          Key_Down = Key_Val & (Key_Val ^ Key_Old);
  50   1          Key_Up = ~Key_Val & (Key_Val ^ Key_Old);
  51   1          Key_Old = Key_Val;
  52   1      
  53   1          /*Test*/
C51 COMPILER V9.60.7.0   MAIN                                                              03/27/2025 20:34:03 PAGE 2   

  54   1          if(Key_Down == 4)
  55   1          {
  56   2              static bit Test_Flag = 0;
  57   2              Test_Flag ^= 1;
  58   2              memset(ucLed,Test_Flag,8);
  59   2              memset(Seg_Point,Test_Flag,8);
  60   2          }
  61   1      
  62   1      }
  63          
  64          /*Task2 Creation Seg Led*/
  65          void Task_Disp(void)
  66          {
  67   1          uint8_t Scan = Mysystick % 8;//æ˜¾ç¤ºæ‰«æå˜é‡ åªåœ¨0â€”â€”7å‘¨æœŸå˜
  68   1      
  69   1          Seg_Disp(Scan,Seg_Buf[Scan],Seg_Point[Scan]);//æ•°ç ç®¡æ˜¾ç¤º
  70   1          LED_Disp(Scan,ucLed[Scan]);//LEDæ˜¾ç¤º
  71   1      }
  72          
  73          /*Task3 Creation NE555*/
  74          void Task_NE555(void)
  75          {
  76   1          static uint16_t Freq = 0;//NE555é¢‘ç‡
  77   1      
  78   1          //æ˜¾ç¤ºæ•°æ®
  79   1          //ä¸ºé¿å…ç¬¬ä¸€æ¬¡æµ‹é‡æ—¶æ²¡æ•°æ®ï¼Œå…ˆåˆå§‹åŒ–ä¸º0ï¼Œå…ˆæ˜¾ç¤ºç¬¬ä¸€æ¬¡å†å¼€å§‹æµ‹é‡
  80   1              Seg_Buf[0] = Freq / 10000 % 10;
  81   1              Seg_Buf[1] = Freq / 1000 % 10;
  82   1              Seg_Buf[2] = Freq / 100 % 10;
  83   1              Seg_Buf[3] = Freq / 10 % 10;
  84   1              Seg_Buf[4] = Freq % 10;
  85   1          
  86   1          TR0 = 0;//å…³é—­TIM0è®¡æ•°
  87   1          ET1 = 0;//å…³é—­TIM1ä¸­æ–­å…è®¸
  88   1          Freq = TH0 << 8 | TL0;//è·å–é¢‘ç‡
  89   1          TH0 = TL0 = 0;//æ‰‹åŠ¨æ¸…ç©ºè®¡æ•°å€¼
  90   1          ET1 = 1;//æ‰“å¼€TIM1ä¸­æ–­å…è®¸
  91   1          TR0 = 1;//å¼€å¯TIM0è®¡æ•°
  92   1      
  93   1      }
  94          
  95          /*Task4 Creation Buzz Motor Relay*/
  96          void Task_Periph(void)
  97          {
  98   1          static bit Flag_Buzz = 0;
  99   1          static bit Flag_Relay = 1;
 100   1      
 101   1          Periph_Set(BUZZ,Flag_Buzz);
 102   1          Periph_Set(RELAY,Flag_Relay);
 103   1      
 104   1          //500msç¿»è½¬ä¸€æ¬¡ç»§ç”µå™¨å’Œèœ‚é¸£å™¨çš„ç”µå¹³
 105   1          Flag_Buzz ^= 1;
 106   1          Flag_Relay ^= 1;
 107   1      }
 108          
 109          /*Task5 Creation DS1302*/
 110          void Task_RTC(void)
 111          {
 112   1          uint8_t i;
 113   1              RTC_Read(ucRTC);
 114   1              Seg_Buf[2] = Seg_Buf[5] = 11;
 115   1          for(i = 0;i < 3; i++)
C51 COMPILER V9.60.7.0   MAIN                                                              03/27/2025 20:34:03 PAGE 3   

 116   1          {
 117   2              Seg_Buf[i * 3] = ucRTC[i] / 10;
 118   2              Seg_Buf[i * 3 + 1] = ucRTC[i] % 10;   
 119   2          }
 120   1      }
 121          
 122          /*Task6 Creation DS18B20*/
 123          void Task_Ds18b20(void)
 124          {
 125   1          temprature = Read_Temprature();//è·å–æ¸©åº¦
 126   1      
 127   1          //æ•°æ®æ˜¾ç¤º
 128   1          Seg_Point[1] = 1;//æ˜¾ç¤ºå°æ•°ç‚¹
 129   1          Seg_Buf[0] = (uint8_t)(temprature * 10) / 100 % 10;
 130   1          Seg_Buf[1] = (uint8_t)(temprature * 10) / 10 % 10;
 131   1          Seg_Buf[2] = (uint8_t)(temprature * 10) % 10;
 132   1      }
 133          
 134          /*Task7 Creation Ultrasonic*/
 135          void Task_Ul(void)
 136          {
 137   1          static uint8_t distance;
 138   1          distance = Distance_Get();//è·å–è·ç¦»
 139   1      
 140   1          //æ˜¾ç¤ºè·ç¦»
 141   1              Seg_Buf[0] = (uint16_t)distance / 100 % 10;
 142   1              Seg_Buf[1] = (uint16_t)distance / 10 % 10;
 143   1              Seg_Buf[2] = (uint16_t)distance % 10;
 144   1      }
 145          
 146          /*Task8 Creation Serial*/
 147          void Task_Serial(void)
 148          {
 149   1          static uint8_t psc = 0;//åˆ†é¢‘å™¨ æ¯1så‘é€ä¸€æ¬¡    
 150   1          
 151   1          if(++psc == 4)
 152   1          {
 153   2              psc = 0;
 154   2              printf("systime:%d\r\n", (uint16_t)(Mysystick / 1000));
 155   2          }
 156   1      
 157   1          if(Serial_Idle_Cnt < 300)//300msæ²¡æ¥å—åˆ°æ•°æ®å°±ä¼šè§£æä¸€æ¬¡
 158   1          {
 159   2              if(RxData[0] == '1')
 160   2              {
 161   3                  static bit i = 0;
 162   3                  index = 0;
 163   3                  RxData[0] = 0;
 164   3                  memset(ucLed, i, 8);
 165   3                  i ^= 1;
 166   3              }
 167   2          }
 168   1      }
 169          
 170          /*Task9 Creation PCF8951*/
 171          void Task_PCF8951(void)
 172          {
 173   1          Adval1 = AD_Read(0x41);//ç”µä½å™¨
 174   1          Adval2 = AD_Read(0x43);//å…‰æ•
 175   1          /*
 176   1              tips:   å¦‚æœåªè¯»ä¸€ä¸ªADå€¼ 0x41ä¸ºå…‰æ• 0x43ä¸ºç”µä½å™¨
 177   1                      ä½†æ˜¯ç”±äºæœ¬æ¬¡è¯»å–åˆ°çš„æ•°æ®æ˜¯ä¸Šä¸€æ¬¡è½¬æ¢çš„ç»“æœã€‚
C51 COMPILER V9.60.7.0   MAIN                                                              03/27/2025 20:34:03 PAGE 4   

 178   1                      æ‰€ä»¥è¿ç»­è¯»æ•°æ®çš„è¯éœ€è¦å°†ä¸¤ä¸ªé€šé“åè½¬ä¸€ä¸‹ã€‚
 179   1          */
 180   1          DA_Write(Adval1);//è¾“å‡ºå¯¹åº”ç”µå‹
 181   1      
 182   1          Seg_Buf[0]=Adval1 / 100 % 10;
 183   1              Seg_Buf[1]=Adval1 / 10 % 10;
 184   1              Seg_Buf[2]=Adval1 % 10;
 185   1      
 186   1          Seg_Buf[5]=Adval2 / 100 % 10;
 187   1              Seg_Buf[6]=Adval2 / 10 % 10;
 188   1              Seg_Buf[7]=Adval2 % 10;
 189   1      
 190   1      }
 191          
 192          /*MAIN*/
 193          void main(void)
 194          {
 195   1          /*Initialize*/
 196   1          temprature = Read_Temprature();
 197   1          Delay(750);
 198   1          memset(Seg_Point,0,8);//åˆå§‹åŒ–æ•°ç ç®¡å°æ•°ç‚¹ç¼“å†²
 199   1          memset(Seg_Buf,10,8);//åˆå§‹åŒ–æ•°ç ç®¡ç¼“å†²åŒº
 200   1          memset(ucLed,0,8);//åˆå§‹åŒ–LEDç¼“å†²åŒº
 201   1          RTC_Set(ucRTC);//å°†éœ€è¦çš„æ—¶é—´éƒ½å†™å…¥RTCä¸­
 202   1          Sys_Init();//åˆå§‹åŒ–LEDå’Œå¤–è®¾
 203   1          // Timer0_Init();//åˆå§‹åŒ–TIM0
 204   1          // Uart1_Init();//åˆå§‹åŒ–ä¸²å£1
 205   1          Timer2_Init();//åˆå§‹åŒ–å¿ƒè·³æ—¶é’Ÿæº
 206   1      
 207   1          /*Task Add*/
 208   1          Task_Add(&Task_Key, 10);
 209   1          // Task_Add(&Task_NE555, 1000);
 210   1          // Task_Add(&Task_Periph, 500);
 211   1          // Task_Add(&Task_RTC, 500);
 212   1          // Task_Add(&Task_Ds18b20, 750);
 213   1          Task_Add(&Task_Ul, 200);
 214   1          // Task_Add(&Task_Serial, 250);
 215   1          //Task_Add(&Task_PCF8951, 200);
 216   1      
 217   1          /*Loop*/
 218   1          while(1)
 219   1          {
 220   2              Task_Start();
 221   2          }
 222   1      }
 223          
 224          /*ISR*/
 225          /*è¿™é‡Œä½¿ç”¨TIM2å®šæ—¶å™¨ä½œä¸ºç³»ç»Ÿå¿ƒè·³æº*/
 226          void Timer2_Isr(void) interrupt 12
 227          {
 228   1          Mysystick ++;
 229   1          Serial_Idle_Cnt ++;
 230   1          Task_Disp();
 231   1      }
 232          
 233          void Uart1_Isr(void) interrupt 4
 234          {
 235   1              if (RI)                         //æ£€æµ‹ä¸²å£1æ¥æ”¶ä¸­æ–­
 236   1              {
 237   2                      RI = 0;                 //æ¸…é™¤ä¸²å£1æ¥æ”¶ä¸­æ–­è¯·æ±‚ä½
 238   2      
 239   2              Serial_Idle_Cnt = 0;//æ²¡æœ‰æ¥æ”¶åˆ°æ•°æ®å°±ä¼šä¸€ç›´è‡ªå¢ï¼Œæ¥æ”¶åˆ°æ•°æ®åä¼šä¿æŒ0ï¼Œé€š
C51 COMPILER V9.60.7.0   MAIN                                                              03/27/2025 20:34:03 PAGE 5   

             -è¿‡è¿™ç‚¹å¯ä»¥è¾¾åˆ°ç©ºé—²è§£æçš„æ•ˆæœ
 240   2      
 241   2                      RxData[index ++] = SBUF;
 242   2              }
 243   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    926    ----
   CONSTANT SIZE    =     13    ----
   XDATA SIZE       =      4    ----
   PDATA SIZE       =     27    ----
   DATA SIZE        =     21       1
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      4    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
